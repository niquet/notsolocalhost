---
title: "Rolling Your Own Config as Code for Anonymous Configs"
slug: config-as-code
date: 2025-07-09
layout: default
---

- Managing configuration as code is a powerful practice
- But what happens when the API or SDK you rely on doesn’t support easy comparison of remote and local configurations?

---

- Managing feature flags (or similar settings) through a UI
- Managing them via configuration files or APIs—treating configurations as structured, version-controlled code—the approach
- All configuration (including feature flags) is defined in code (YAML, JSON, etc.) or via APIs, not manually in a UI
- Configurations are stored in version control systems, allowing for change tracking, reviews, and rollbacks
- Feature flags can be managed as code by:
  - Defining their states and rules in configuration files.
  - Using APIs to read, update, and deploy flag configurations, bypassing the need for a UI.
  - Integrating with CI/CD pipelines for automated rollout and rollback

---

Common challenges

- No Built-in diff support: Many APIs/SDKs for feature flags or configuration management lack native tools to compare remote and local states
- No unique identifiers: Config entries may not have stable names or IDs, making direct comparison tricky
- Manual effort: Without automation, tracking changes is error-prone and time-consuming

Specific problem

- Setting up configuration as code for ~700 experiments previously stored on the backend for a UI
- API/SDK for basic CRUD operations
- Getting configurations from remote works
- Main issue: No logic to compare remote config (or parts of it) to current local config
- Only identifier for configuration is the internal database ID
- Doesn't make sense to store that in the configuration files for multiple reasons
- Need a way to compare and know exactly what to change and on which remote entry id

Overview

- You can implement a custom logic that:
  - Fetches remote configuration via API
  - Reads local configuration from your repository
  - Normalizes both configurations (e.g., sorts keys, strips metadata)
  - Generates signatures or hashes for each config object
  - Compares these signatures to detect additions, deletions, or modifications

Fetch and normalize configurations

- Remote: Use the API to retrieve the current configuration state
- Local: Parse the configuration files from your code repository
- Normalize: Sort keys, remove timestamps or irrelevant fields, and ensure consistent formatting

Generate Signatures or Hashes

- For each config object, create a hash (e.g., SHA256) of its normalized representation
- This allows you to compare objects even without unique names
- Use Stable Serialization: Always serialize config objects in a consistent way before hashing
- Ignore Non-Essential Fields: Exclude fields like timestamps or autogenerated IDs to avoid false positives

Compare and detect changes

- Added: Hashes present locally but not remotely
- Removed: Hashes present remotely but not locally
- Modified: Hashes with matching structure but differing content

Report or act

- Output a report of differences for review
- Optionally, automate syncing or alerting based on the detected changes

---

- We're given a dummy SDK `sdk` with a few functions out of the box
- A response object can be queried for platforms, features, rollouts
- Here's an overview of relevant SDK functionality (given by SDK)

- High level functions:
  - `createConfig(platform, environment, name)`: creates a config on the given platform
  - `retrieveConfig(platform, environment, name)`: gets a config from the given platform
- Config level functions:
  - `getPlatforms()`
  - `getName()`
  - `getRolloutById()`
  - `getFeatures()`
  - `getFeatureById()`
  - `getFeatureByName()`
  - `getFeatureByValue)`
  - `addFeature()`
  - `addRollout()`
  - `changeFeatureName()`
  - `changeFeatureValue()`
  - `clearFeatures()`
  - `commitChanges()`
  - `disableConfig()`
  - `enableConfig()`
  - `removeRollout()`
  - `replaceRollout()`

---

- 

---

- Simple configuration structure for the purpose of this post
- Mobile feature flag and rollout management configuration
- Enables control over which features are available to users, how widely they are rolled out, and to manage different values and rollout strategies per platform in the production environment
- Local configuration as YAML file

```yaml
name: dummy
kind: mobile
platforms:
  - name: android
    features:
      - name: feature1
        value: 100
      - name: feature2
        value: 0
      - name: feature3
        value: 0
      - name: feature4
        value: 50
    environment:
      - name: production
        enabled: true
    rollout:
      - weight: 33000
        enabled: true
        feature: feature1
      - weight: 33000
        enabled: true
        feature: feature2
      - weight: 34000
        enabled: true
        feature: feature3
      - weight: 0
        enabled: false
        feature: feature4
  - name: ios
    features:
      - name: feature1
        value: 0
      - name: feature2
        value: 10
      - name: feature3
        value: 0
      - name: feature4
        value: 40
    environment:
      - name: production
        enabled: true
    rollout:
      - weight: 33000
        enabled: true
        feature: feature1
      - weight: 33000
        enabled: true
        feature: feature2
      - weight: 34000
        enabled: true
        feature: feature3
      - weight: 0
        enabled: false
        feature: feature4
```

- Remote configuration JSON:

```json
{
  "id": "1",
  "name": "dummy_android",
  "kind": "mobile",
  "created_at": "2025-07-09T12:42:00.953753Z",
  "updated_at": "2025-07-09T12:42:00.953769Z",
  "platforms": [
    {
        "id": "1",
        "name": "android",
        "created_at": "2025-07-09T12:42:00.953681Z",
        "updated_at": "2025-07-09T12:42:00.953698Z",
        "environment": {
            "name": "production",
            "enabled": true
        },
        "features": [
        {
          "id": "1",
          "created_at": "2025-07-09T12:42:00.953547Z",
          "updated_at": "2025-07-09T12:42:00.953627Z",
          "rollout": [
            {
                "id": "1",
                "featureId": "1",
                "created_at": "2025-07-09T12:42:00.953638Z",
                "updated_at": "2025-07-09T12:42:00.953642Z",
                "weight": 33000,
                "enabled": true
            }
            },
            {
                "id": "2",
                "featureId": "2",
                "created_at": "2025-07-09T12:42:00.953638Z",
                "updated_at": "2025-07-09T12:42:00.953642Z",
                "weight": 33000,
                "enabled": true
            },
            {
                "id": "3",
                "featureId": "3",
                "created_at": "2025-07-09T12:42:00.953646Z",
                "updated_at": "2025-07-09T12:42:00.953649Z",
                "weight": 34000,

            },
            {
                "id": "4",
                "featureId": "4",
                "created_at": "2025-07-09T12:42:00.953653Z",
                "updated_at": "2025-07-09T12:42:00.953655Z",
                "weight": 0,
                "enabled": false
            }
        ]
    },
    {
      "id": "platform_ios",
      "name": "ios",
      "created_at": "2025-07-09T12:42:00.953730Z",
      "updated_at": "2025-07-09T12:42:00.953733Z",
      "environment": {
        "name": "production",
        "enabled": true
      },
      "features": [
        {
          "id": "feature_feature1",
          "name": "feature1",
          "value": 0,
          "created_at": "2025-07-09T12:42:00.953703Z",
          "updated_at": "2025-07-09T12:42:00.953706Z",
          "rollout": {
            "weight": 33000,
            "enabled": true
          }
        },
        {
          "id": "feature_feature2",
          "name": "feature2",
          "value": 10,
          "created_at": "2025-07-09T12:42:00.953710Z",
          "updated_at": "2025-07-09T12:42:00.953713Z",
          "rollout": {
            "weight": 33000,
            "enabled": true
          }
        },
        {
          "id": "feature_feature3",
          "name": "feature3",
          "value": 0,
          "created_at": "2025-07-09T12:42:00.953717Z",
          "updated_at": "2025-07-09T12:42:00.953720Z",
          "rollout": {
            "weight": 34000,
            "enabled": true
          }
        },
        {
          "id": "feature_feature4",
          "name": "feature4",
          "value": 40,
          "created_at": "2025-07-09T12:42:00.953723Z",
          "updated_at": "2025-07-09T12:42:00.953726Z",
          "rollout": {
            "weight": 0,
            "enabled": false
          }
        }
      ]
    }
  ]
}
```
